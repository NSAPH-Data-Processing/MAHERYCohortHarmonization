<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Tracking Input Data • MAHERYCohortHarmonization</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Tracking Input Data">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">MAHERYCohortHarmonization</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/get-started.html">Get started</a></li>
    <li><a class="dropdown-item" href="../articles/opensrp-cohort-2018-preprocessing.html">OpenSRP Cohort 2018 Preprocessing</a></li>
    <li><a class="dropdown-item" href="../articles/OutputTables.html">Pipeline Outputs</a></li>
    <li><a class="dropdown-item" href="../articles/preprocessing-2018-health-status.html">Preprocessing 2018 Health Status</a></li>
    <li><a class="dropdown-item" href="../articles/preprocessing-2018-household-heads.html">Preprocessing 2018 Household Heads</a></li>
    <li><a class="dropdown-item" href="../articles/tracking-input-data.html">Tracking Input Data</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Tracking Input Data</h1>
                        <h4 data-toc-skip class="author">Tinashe M.
Tapera</h4>
            
      

      <div class="d-none name"><code>tracking-input-data.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">MAHERYCohortHarmonization</span><span class="op">)</span></span></code></pre></div>
<!-- WARNING - This vignette is generated by {fusen} from dev/flat_tracking_inputs.Rmd: do not edit by hand -->
<div class="section level2">
<h2 id="tracking-inputs">Tracking Inputs<a class="anchor" aria-label="anchor" href="#tracking-inputs"></a>
</h2>
<p>In this notebook, we’re developing functions to track all of the
input data. Importantly, this data is stored on Google Drive and must
not be shared publicly on the internet, so we will need to use
programmatic credentials to access it.</p>
<p>Let’s first create a function that will log us in to google drive
with the appropriate credentials. For this, we’ll use the
<code>googledrive</code> package from <code>tidyverse</code>.</p>
<p>We can start the process of authorization using the
<code><a href="https://googledrive.tidyverse.org/reference/drive_auth.html" class="external-link">drive_auth()</a></code> function. This requires access to the a
special JSON file that contains the credentials for the google drive
account.</p>
<p>To enable non-interactive access to Google Drive from this R package,
we use a <em>Google Cloud service account</em> for authentication. This
allows scripts and functions to interact with Google Drive without
requiring manual sign-in or browser-based authentication. It’s
particularly useful for automated workflows, scheduled tasks, or when
deploying the package in cloud environments (e.g., on a server like
<code>FASRC</code>). The service account acts like a dummy user with its
own credentials, and it can be granted access to specific files or
folders in the CSPH drives. Access to the service account can be
controlled via sharing permissions just like any human Google Drive
user.</p>
<p>To set this up, the service account was created via the Google Cloud
Console under a project with the Google Drive API enabled. A JSON key
was generated and downloaded — this file contains the credentials used
to authenticate in R. Any Google Drive resources the package needs to
access must be explicitly shared with the service account’s email (in
this case,
<code>data-pipeline@harvard-csph-driveauth.iam.gserviceaccount.com</code>).
Once shared, the pipeline uses the <code>googledrive</code> package in R
to authenticate via <code>drive_auth(path = "path/to/key.json")</code>,
allowing Drive operations to run seamlessly.</p>
<p>This authentication method ensures that all users of this package (or
future maintainers) can use a consistent, secured credential file for
Drive access. To maintain this setup, keep the JSON key file in a
protected location, and do not commit it to version control. If the key
ever needs to be regenerated (e.g., due to compromise or rotation), the
same process above can be followed to create a new one.</p>
<div class="section level3">
<h3 id="authenticating-with-google-drive">Authenticating with Google Drive<a class="anchor" aria-label="anchor" href="#authenticating-with-google-drive"></a>
</h3>
<p>If you have the authentication file, you can simply point to it with
your <code><a href="https://googledrive.tidyverse.org/reference/drive_auth.html" class="external-link">drive_auth()</a></code> function in an interactive session. If
this is successful, you should be able to access the Google Drive files
from R with <code><a href="https://googledrive.tidyverse.org/reference/drive_find.html" class="external-link">drive_find()</a></code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">path_to_auth</span> <span class="op">&lt;-</span> <span class="st">"path/to/your/auth.json"</span></span>
<span><span class="fu"><a href="https://googledrive.tidyverse.org/reference/drive_auth.html" class="external-link">drive_auth</a></span><span class="op">(</span>path <span class="op">=</span> <span class="va">path_to_auth</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://googledrive.tidyverse.org/reference/drive_find.html" class="external-link">drive_find</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>In a non-interactive session, make sure to set the environment
variable with <code>.Renviron</code>.</p>
<div class="section level4">
<h4 id="authenticate_google_drive">authenticate_google_drive<a class="anchor" aria-label="anchor" href="#authenticate_google_drive"></a>
</h4>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/authenticate_google_drive.html">authenticate_google_drive</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>We can add this to the beginning of our <code>targets</code>
pipeline.</p>
</div>
</div>
<div class="section level3">
<h3 id="ensuring-files-have-not-changed">Ensuring Files Have Not Changed<a class="anchor" aria-label="anchor" href="#ensuring-files-have-not-changed"></a>
</h3>
<p>Ensuring that files haven’t changed is important for reproducibility,
but is also arguably quite tricky with Google drive. Anyone with the
link and access can change the file, and this can break the pipeline. We
can’t really check the hash of the file, but we can check the last
modified date. This is not perfect, but it’s better than nothing. We can
also add checks in the pipeline via assertions and test_that functions
such that the pipeline won’t be broken if the file is changed.</p>
<div class="warning">
<p><strong>Warning:</strong> <italic>DO NOT</italic> use file ID
identifiers in rendered HTML vignettes, as they can be used to access
the Google Drive if sharing is enabled. This is a security risk.
Instead, use the file name and
<code>drive_find(pattern = [REGEX])</code> to reference files.</p>
</div>
<div class="section level4">
<h4 id="has_drive_file_changed">has_drive_file_changed<a class="anchor" aria-label="anchor" href="#has_drive_file_changed"></a>
</h4>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test_file</span> <span class="op">&lt;-</span> <span class="st">"1X9pd4nOjl33zDFfTjw-_eFL7Qb9_g6VfVFDp1PPae94"</span></span>
<span><span class="fu"><a href="../reference/has_drive_file_changed.html">has_drive_file_changed</a></span><span class="op">(</span><span class="va">test_file</span>, <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd_hms.html" class="external-link">ymd_hms</a></span><span class="op">(</span><span class="st">"2025-04-01 00:00:00"</span>, tz <span class="op">=</span> <span class="st">"UTC"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="local-data-paths">Local Data Paths<a class="anchor" aria-label="anchor" href="#local-data-paths"></a>
</h3>
<p>Here’s a utility for creating data paths in any local environment
using <code>here</code> and <code>fs</code>:</p>
</div>
</div>
<div class="section level2">
<h2 id="create_datapaths">create_datapaths<a class="anchor" aria-label="anchor" href="#create_datapaths"></a>
</h2>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span><span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/create_datapaths.html">create_datapaths</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span> </span></code></pre></div>
<div class="section level3">
<h3 id="northeast-data">Northeast Data<a class="anchor" aria-label="anchor" href="#northeast-data"></a>
</h3>
<p>Now that we have access to the Google Drive, we can start tracking
the input data. We’ll start with the Northeast data.</p>
<p>Time order of the data files: * Year 2018: openSRP_data_2018.xlsx *
Year 2019: Dharma_followup_2020plus.xlsx * Beyond 2019:
Dharma_2019_2020.csv</p>
<p>First, we simply track the state of these input files from
googledrive. We’ll simply use a list to store the file names and their
IDs, and then pass that list to the target pipeline.</p>
</div>
</div>
<div class="section level2">
<h2 id="download_to_local">download_to_local<a class="anchor" aria-label="anchor" href="#download_to_local"></a>
</h2>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/authenticate_google_drive.html">authenticate_google_drive</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">test_file</span> <span class="op">&lt;-</span> <span class="st">"openSRP_dictionary.xlsx"</span></span>
<span><span class="va">fpath</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/download_to_local.html">download_to_local</a></span><span class="op">(</span><span class="va">test_file</span>, <span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org/reference/here.html" class="external-link">here</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">fpath</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.remove</a></span><span class="op">(</span><span class="va">fpath</span><span class="op">)</span></span></code></pre></div>
<p>With this in mind, we can likely dedicate a section to each of the
files, using a function to track each one.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Tinashe Tapera.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
